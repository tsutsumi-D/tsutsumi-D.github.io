<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>scriptè¦ç´ ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</title>
  </head>
  <body>
    <span>scriptè¦ç´ ã®ã‚µãƒ³ãƒ—ãƒ«</span>

<script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
<canvas id="draw-area" width="280" height="280" style="border: 2px solid;"></canvas>
<script>
  alert('====canvas make=====')
  // init SignaturePad
  const drawElement = document.getElementById('draw-area');
  const signaturePad = new SignaturePad(drawElement, {
      minWidth: 6,
      maxWidth: 6,
      penColor: 'white',
      backgroundColor: 'black',
  });
  alert('====canvas make FINISH=====')
</script>







<a id="predict-button" class="button is-link is-loading" onclick="main();">Prediction</a>
<a class="button" onclick="reset()">Reset</a>

<script>
function getImageData() {
    const inputWidth = inputHeight = 28;
    // resize
    const tmpCanvas = document.createElement('canvas').getContext('2d');
    tmpCanvas.drawImage(drawElement, 0, 0, inputWidth, inputHeight);
    // convert grayscale
    let imageData = tmpCanvas.getImageData(0, 0, inputWidth, inputHeight);
    for (let i = 0; i < imageData.data.length; i+=4) {
        const avg = (imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3;
        imageData.data[i] = imageData.data[i+1] = imageData.data[i+2] = avg;
    }
    return imageData;
}
  function reset() {
      signaturePad.clear();
      let elements = document.querySelectorAll(".accuracy");
      elements.forEach(el => {
          el.parentNode.classList.remove('is-selected');
          el.innerText = '-';
      })
  }


function DrowAndShow(){
    alert('canvas save')

  // ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹è¦ç´ ã‚’å–å¾— (æ—¢ã«æç”»ã•ã‚Œã¦ã„ã‚‹)
  var ccccc = document.getElementById("draw-area");
    alert('canvas save FINISH')
  // æç”»å†…å®¹ã‚’ãƒ‡ãƒ¼ã‚¿URIã«å¤‰æ›ã™ã‚‹ (å¼•æ•°ãªã—ã ã¨PNG)
  var dataURI = ccccc.toDataURL("png");
  // imgè¦ç´ ã‚’å–å¾—
  var image = document.getElementById("output");
  // ãƒ‡ãƒ¼ã‚¿URIã¯ç›´æ¥imgè¦ç´ ã®srcå±æ€§ã«æŒ‡å®šã§ãã‚‹
  image.src = dataURI;

    const preview = document.getElementById('preview');
    const img = document.createElement("img"); // imgè¦ç´ ã‚’ä½œæˆ
    img.src = dataURI; // URLã‚’imgè¦ç´ ã«ã‚»ãƒƒãƒˆ
    preview.appendChild(img); // #previewã®ä¸­ã«è¿½åŠ 
}
</script>

<a class="button" onclick="DrowAndShow()">DrowAndShow</a>
<img id="output" src="">





<!-- ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
<input type="file" id="example" multiple>
<!-- ğŸ‘‡ã“ã“ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’è¿½åŠ ã™ã‚‹ -->
<div id="preview"></div>

<script>
function previewFile(file) {
  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’è¿½åŠ ã™ã‚‹è¦ç´ 
  const preview = document.getElementById('preview');

  // FileReaderã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
  const reader = new FileReader();

  // URLã¨ã—ã¦èª­ã¿è¾¼ã¾ã‚ŒãŸã¨ãã«å®Ÿè¡Œã™ã‚‹å‡¦ç†
  reader.onload = function (e) {
    const imageUrl = e.target.result; // URLã¯event.target.resultã§å‘¼ã³å‡ºã›ã‚‹
    const img = document.createElement("img"); // imgè¦ç´ ã‚’ä½œæˆ
    img.src = imageUrl; // URLã‚’imgè¦ç´ ã«ã‚»ãƒƒãƒˆ
    preview.appendChild(img); // #previewã®ä¸­ã«è¿½åŠ 
  }

  // ã„ã–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’URLã¨ã—ã¦èª­ã¿è¾¼ã‚€
  reader.readAsDataURL(file);
}
const fileInput = document.getElementById('example');
const handleFileSelect = () => {
  const files = fileInput.files;
  for (let i = 0; i < files.length; i++) {
    previewFile(files[i]);
  }
}
fileInput.addEventListener('change', handleFileSelect);
</script>







<!-- Load TensorFlow.js -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.13.0"></script>
<script>// <![CDATA[
async function main(){
  alert("======main() START=======")
  const serverPATH = 'https://tsutsumi-d.github.io/';
  //const serverPATH = 'http://127.0.0.1:8887/';
  const model = await tf.loadLayersModel(serverPATH + 'model/model.json');
   //ç”»åƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ
   var width = 28;
   var height = 28;
   var img = new Image();
   img.src = serverPATH + 'images/004.png';
   var canvas = document.createElement("canvas");
     canvas.setAttribute("width", width);
     canvas.setAttribute("height", height);
     var context = canvas.getContext("2d");
     context.drawImage(img, 0, 0, width, height);
     var imageData = context.getImageData(0, 0, width, height);
     const example = tf.fromPixels(imageData, 1).reshape([1,28,28,1]);
   const prediction = model.predict(example);
   alert("======333333=======")
   alert(prediction)
   //$("#result").text("ã“ã®ç”»åƒã®æ•°å­—ã¯ã€Œ" + prediction.argMax(-1).dataSync() + "ã€ã ã‚ˆï¼");
}
// ]]></script>



  </body>
</html>